name: Publish Docker Image to Docker Hub

on:
  release:
    types: [published]

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  REGISTRY: docker.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract version from release tag
        id: extract_version
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          GOST_HTTP_VERSION="${RELEASE_TAG#v}"
          # Form RELEASE_TAG as v{GOST_HTTP_VERSION}
          RELEASE_TAG="v${GOST_HTTP_VERSION}"
          echo "GOST_HTTP_VERSION=${GOST_HTTP_VERSION}" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "Extracted GOST_HTTP_VERSION: ${GOST_HTTP_VERSION}"
          echo "Formed RELEASE_TAG: ${RELEASE_TAG}"

      - name: Extract Python version from Dockerfile
        id: extract_python_version
        run: |
          # Extract Python version from Dockerfile and use as is (no modifications)
          # If PYTHON_VERSION=3.12, Docker will use the latest 3.12.x base image
          # If PYTHON_VERSION=3.12.14, Docker will use the specific 3.12.14 base image
          PYTHON_VERSION=$(grep -E "^ARG PYTHON_VERSION=" Dockerfile | sed 's/ARG PYTHON_VERSION=//' | sed 's/^"//' | sed 's/"$//' | tr -d '[:space:]' || echo "3.12")
          echo "PYTHON_VERSION=${PYTHON_VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted Python version: ${PYTHON_VERSION}"

      - name: Set image metadata
        id: meta
        run: |
          PYTHON_VERSION="${{ steps.extract_python_version.outputs.PYTHON_VERSION }}"
          RELEASE_TAG="${{ steps.extract_version.outputs.RELEASE_TAG }}"
          IMAGE_TAG="${PYTHON_VERSION}-alpine-${RELEASE_TAG}"
          REGISTRY="${{ env.REGISTRY }}"
          DOCKERHUB_USERNAME="${{ env.DOCKERHUB_USERNAME }}"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "tags=${REGISTRY}/${DOCKERHUB_USERNAME}/python-gost-engine:${IMAGE_TAG},${REGISTRY}/${DOCKERHUB_USERNAME}/python-gost-engine:latest" >> $GITHUB_OUTPUT
          echo "Image tag: ${IMAGE_TAG}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          build-args: |
            PYTHON_VERSION=${{ steps.extract_python_version.outputs.PYTHON_VERSION }}
            GOST_HTTP_VERSION=${{ steps.extract_version.outputs.GOST_HTTP_VERSION }}
            ALPINE_VERSION=3
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.DOCKERHUB_USERNAME }}/python-gost-engine:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.DOCKERHUB_USERNAME }}/python-gost-engine:buildcache,mode=max

